<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title></title>
    <script src="/static/react.js"></script>
    <script src="/static/JSXTransformer.js"></script>
    <style type="text/css">
        table {
            text-align: center
        }

        th {
            border: solid salmon;
            border-width: 0px 0px 1px 1px
        }

        td {
            border: solid salmon;
            border-width: 0px 0px 1px 1px
        }
    </style>
</head>
<body>
<div id="content"></div>
<script type="text/jsx">
    var buildings = [];
    {% for d in data %}
        var temp = {};
        temp['char_id'] = "{{ d.id }}";

        var list = [];
        {% for k, v in d.buildings.items %}
            var t = {};
            var t_k = "{{ k }}";
            var t_v = "{{ v }}";
            t['k'] = t_k;
            t['v'] = t_v;

            list.push(t);
        {% endfor %}
        temp['buildings'] = list;

        buildings.push(temp);
    {% endfor %}

    var BuildingRow = React.createClass({
        render: function () {
            return (
                    <li>{this.props.building.k}: {this.props.building.v}</li>
            );
        }
    });

    var MakeRow = React.createClass({
        render: function () {
            var rows = [];
            this.props.building.buildings.forEach(function (building) {
                rows.push(<BuildingRow building={building}/>);
            }.bind(this));
            return (
                    <tr>
                        <td>{this.props.building.char_id}</td>
                        <td>{rows}</td>
                    </tr>
            );
        }
    });

    var SearchBar = React.createClass({

        handleChange: function () {
            this.props.onUserInput(
                    this.refs.filterTextInput.getDOMNode().value
            );
        },

        render: function () {
            return (
                    <form>
                        <input
                                type="text"
                                placeholder="Search...ID"
                                value={this.props.filterText}
                                ref="filterTextInput"
                                onChange={this.handleChange}
                                />
                    </form>
            );
        }
    });

    var BuildingTable = React.createClass({
        render: function () {
            var rows = [];
            this.props.buildings.forEach(function (building) {
                if (building.char_id.indexOf(this.props.filterText) === -1) {
                    return;
                }
                rows.push(<MakeRow building={building}/>);
            }.bind(this));

            return (
                    <table>
                        {this.props.filterText}
                        <tr>
                            <th>帐号ID</th>
                            <th>建筑等级</th>
                        </tr>
                        {rows}
                    </table>
            );
        }
    });

    var BuildingForm = React.createClass({

        getInitialState: function () {
            return {
                filterText: ''
            };
        },

        handleUserInput: function (filterText) {
            this.setState({
                filterText: filterText
            });
        },

        render: function () {
            return (
                    <div>
                        <h1>建筑</h1>
                        <SearchBar
                                filterText={this.state.filterText}
                                onUserInput={this.handleUserInput}
                                />
                        <BuildingTable
                                buildings={this.props.buildings}
                                filterText={this.state.filterText}
                                />
                    </div>
            );
        }
    });

    React.render(
            <BuildingForm buildings={buildings}/>,
            document.getElementById('content')
    );
</script>
</body>
</html>