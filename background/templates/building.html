<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title></title>
    <script src="/static/react.js"></script>
    <script src="/static/JSXTransformer.js"></script>
    <style type="text/css">
        table {
            text-align: center
        }

        th {
            border: solid salmon;
            border-width: 0px 0px 1px 1px
        }

        td {
            border: solid salmon;
            border-width: 0px 0px 1px 1px
        }
    </style>
</head>
<body>
<div id="content"></div>
<script type="text/jsx">
    var building_data = [];
    {% for d in data %}
        var row = {};
        row['char'] = "{{ d.id }}";

        var buildings = [];
        {% for k, v in d.buildings.items %}
            var building = {};
            building['id'] = "{{ k }}";
            building['level'] = "{{ v }}";

            buildings.push(building);
        {% endfor %}
        row['buildings'] = buildings;

        building_data.push(row);
    {% endfor %}

    var BuildingRow = React.createClass({
        render: function () {
            return (
                    <li>{this.props.building.id}: {this.props.building.level}</li>
            );
        }
    });

    var MakeRow = React.createClass({
        render: function () {
            var rows = [];
            this.props.row.buildings.forEach(function (building) {
                rows.push(<BuildingRow building={building}/>);
            }.bind(this));
            return (
                    <tr>
                        <td>{this.props.row.char}</td>
                        <td>{rows}</td>
                    </tr>
            );
        }
    });

    var BuildingTable = React.createClass({
        render: function () {
            var rows = [];
            var a = 0;
            this.props.data.forEach(function (row) {
                if (row.char.indexOf(this.props.filterText) === -1 ) {
                    return;
                }

                a += 1;
                rows.push(<MakeRow row={row}/>);
            }.bind(this));

            return (
                    <table>
                        <thead>
                            <tr>
                                <th>帐号ID</th>
                                <th>建筑等级</th>
                            </tr>
                        </thead>
                        <tbody>{rows}</tbody>
                    </table>
            );
        }
    });

    var SearchBar = React.createClass({

        handleChange: function () {
            this.props.onUserInput(
                    this.refs.filterTextInput.getDOMNode().value
            );
        },

        render: function () {
            return (
                    <form>
                        <input
                                type="text"
                                placeholder="Search...ID"
                                value={this.props.filterText}
                                ref="filterTextInput"
                                onChange={this.handleChange}
                                />
                    </form>
            );
        }
    });

    var BuildingForm = React.createClass({

        getInitialState: function () {
            return {
                filterText: ''
            };
        },

        handleUserInput: function (filterText) {
            this.setState({
                filterText: filterText
            });
        },

        render: function () {
            return (
                    <div>
                        <h1>建筑</h1>
                        <SearchBar
                                filterText={this.state.filterText}
                                onUserInput={this.handleUserInput}
                                />
                        <BuildingTable
                                data={this.props.data}
                                filterText={this.state.filterText}
                                />
                    </div>
            );
        }
    });

    React.render(
            <BuildingForm data={building_data}/>,
            document.getElementById('content')
    );
</script>
</body>
</html>